// ImageResizer.js
import { useState } from "react";

export default function ImageResizer() {
    const sizes = [
        { key: "icon", name: "icon.png", width: 29, height: 29, format: "image/png" },
        { key: "icon2x", name: "icon@2x.png", width: 58, height: 58, format: "image/png" },
        { key: "icon3x", name: "icon@3x.png", width: 87, height: 87, format: "image/png" },
        { key: "logo", name: "logo.png", width: 100, height: 50, format: "image/png" },
        { key: "logo2x", name: "logo@2x.png", width: 200, height: 100, format: "image/png" },
        { key: "logo3x", name: "logo@3x.png", width: 300, height: 150, format: "image/png" },
    ];

    const [files, setFiles] = useState({});
    const [previewUrls, setPreviewUrls] = useState({});
    const [downloadLinks, setDownloadLinks] = useState([]);

    const handleFileChange = (event, key) => {
        const file = event.target.files[0];
        if (!file) return;
        
        setFiles(prevFiles => ({ ...prevFiles, [key]: file }));

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            setPreviewUrls(prevUrls => ({ ...prevUrls, [key]: e.target.result }));
        };
    };

    const processFiles = () => {
        setDownloadLinks([]); // Rensa gamla länkar

        sizes.forEach((size) => {
            const file = files[size.key];
            if (!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    resizeImage(img, size.width, size.height, size.name, size.format);
                };
            };
        });
    };

    const resizeImage = (img, targetWidth, targetHeight, outputName, format) => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        // Behåll proportionerna
        const scale = Math.min(targetWidth / img.width, targetHeight / img.height);
        const width = img.width * scale;
        const height = img.height * scale;

        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);

        canvas.toBlob((blob) => {
            if (!blob) return;
            const url = URL.createObjectURL(blob);
            setDownloadLinks(prevLinks => [...prevLinks, { url, name: outputName }]);
        }, format);
    };

    return (
        <div className="min-h-screen bg-black text-white font-sans flex flex-col items-center py-10">
            <h1 className="text-4xl font-semibold mb-6">Apple Wallet Image Resizer</h1>
            <p className="text-lg opacity-80 mb-8 max-w-2xl text-center">
                Upload your images and get them resized to the correct dimensions for Apple Wallet passes.
            </p>

            <div className="bg-gray-900 p-6 rounded-xl shadow-lg w-full max-w-md">
                {sizes.map((size) => (
                    <div key={size.key} className="mb-4">
                        <label className="block font-medium mb-1">Upload {size.name}:</label>
                        <input type="file" accept="image/*" onChange={(e) => handleFileChange(e, size.key)} className="w-full p-2 bg-gray-800 border border-gray-700 rounded-lg text-white" />
                    </div>
                ))}
                <button onClick={processFiles} className="mt-4 w-full bg-blue-600 hover:bg-blue-500 text-white p-3 rounded-lg font-medium">Upload & Resize</button>
            </div>

            {downloadLinks.length > 0 && (
                <div className="mt-8 bg-gray-900 p-6 rounded-xl shadow-lg w-full max-w-md">
                    <h2 className="text-xl font-semibold mb-4">Download Resized Images:</h2>
                    <ul className="space-y-2">
                        {downloadLinks.map((file, index) => (
                            <li key={index} className="mt-2">
                                <a href={file.url} download={file.name} className="text-blue-400 hover:text-blue-300 underline">
                                    {file.name}
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            )}
        </div>
    );
}
