// ImageResizer.js
import { useState } from "react";

export default function ImageResizer() {
    const sizes = [
        { key: "icon", name: "icon.png", width: 29, height: 29, format: "image/png" },
        { key: "icon2x", name: "icon@2x.png", width: 58, height: 58, format: "image/png" },
        { key: "icon3x", name: "icon@3x.png", width: 87, height: 87, format: "image/png" },
        { key: "logo", name: "logo.png", width: 100, height: 50, format: "image/png" },
        { key: "logo2x", name: "logo@2x.png", width: 200, height: 100, format: "image/png" },
        { key: "logo3x", name: "logo@3x.png", width: 300, height: 150, format: "image/png" },
    ];

    const [files, setFiles] = useState({});
    const [previewUrls, setPreviewUrls] = useState({});
    const [downloadLinks, setDownloadLinks] = useState([]);

    const handleFileChange = (event, key) => {
        const file = event.target.files[0];
        setFiles({ ...files, [key]: file });

        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = (e) => {
            setPreviewUrls({ ...previewUrls, [key]: e.target.result });
        };
    };

    const processFiles = () => {
        let newLinks = [];

        sizes.forEach((size) => {
            const file = files[size.key];
            if (!file) return;

            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (e) => {
                const img = new Image();
                img.src = e.target.result;
                img.onload = () => {
                    resizeImage(img, size.width, size.height, size.name, size.format, newLinks);
                };
            };
        });
    };

    const resizeImage = (img, targetWidth, targetHeight, outputName, format, newLinks) => {
        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");

        // BehÃ¥ll proportionerna
        const aspectRatio = img.width / img.height;
        let width = targetWidth;
        let height = targetHeight;
        
        if (img.width > img.height) {
            height = width / aspectRatio;
        } else {
            width = height * aspectRatio;
        }

        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(img, 0, 0, width, height);

        canvas.toBlob((blob) => {
            if (!blob) return;
            const url = URL.createObjectURL(blob);
            newLinks.push({ url, name: outputName });
            setDownloadLinks([...newLinks]);
        }, format);
    };

    return (
        <div className="p-4">
            <h1 className="text-xl font-bold mb-4">Image Resizer for Apple Wallet</h1>
            {sizes.map((size) => (
                <div key={size.key} className="mb-2">
                    <label className="block font-bold">Upload {size.name}:</label>
                    <input type="file" accept="image/*" onChange={(e) => handleFileChange(e, size.key)} className="border p-2" />
                </div>
            ))}
            <button onClick={processFiles} className="mt-4 bg-blue-500 text-white p-2 rounded">Upload & Resize</button>
            
            {downloadLinks.length > 0 && (
                <div className="mt-4">
                    <h2 className="text-lg font-bold">Download Resized Images:</h2>
                    <ul>
                        {downloadLinks.map((file, index) => (
                            <li key={index} className="mt-2">
                                <a href={file.url} download={file.name} className="text-blue-600 underline">
                                    {file.name}
                                </a>
                            </li>
                        ))}
                    </ul>
                </div>
            )}
            
            <div className="mt-8 border p-4 rounded shadow-md bg-gray-100">
                <h2 className="text-lg font-bold mb-2">Apple Wallet Preview</h2>
                <div className="relative w-[320px] h-[180px] bg-white border rounded-lg shadow-md p-4">
                    <div className="absolute top-2 left-2 w-[29px] h-[29px]">
                        {previewUrls.icon && <img src={previewUrls.icon} alt="Icon" className="w-full h-full object-contain" />}
                    </div>
                    <div className="absolute top-2 left-12 w-[100px] h-[50px]">
                        {previewUrls.logo && <img src={previewUrls.logo} alt="Logo" className="w-full h-full object-contain" />}
                    </div>
                </div>
            </div>
        </div>
    );
}
